# ============================================================================
# ç¬¬äº”ç«  æ›æ°—è¨­å‚™
# Ver.05ï¼ˆã‚¨ãƒãƒ«ã‚®ãƒ¼æ¶ˆè²»æ€§èƒ½è¨ˆç®—ãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼ˆä½å®…ç‰ˆï¼‰Ver.02ï½ï¼‰
# ============================================================================

import numpy as np
from math import ceil
from pyhees.section11_3 import load_schedule, get_schedule_v


# ============================================================================
# 5. æ©Ÿæ¢°æ›æ°—è¨­å‚™ã®æ¶ˆè²»é›»åŠ›é‡
# ============================================================================

def calc_E_E_V_d_t(n_p, A_A, V, HEX=None):
    """1 æ™‚é–“å½“ãŸã‚Šã®æ©Ÿæ¢°æ›æ°—è¨­å‚™ã®æ¶ˆè²»é›»åŠ›é‡ï¼ˆkWh/hï¼‰

    Args:
      n_p(float): ä»®æƒ³å±…ä½äººæ•°
      A_A(float): åºŠé¢ç©ã®åˆè¨ˆ[m^2]
      V(dict): æ›æ°—è¨­å‚™ä»•æ§˜è¾æ›¸
      HEX(dict, optional): ç†±äº¤æ›å™¨å‹è¨­å‚™ä»•æ§˜è¾æ›¸ (Default value = None)

    Returns:
      ndarray: E_E_V_d_t æ—¥ä»˜dã®æ™‚åˆ»tã«ãŠã‘ã‚‹1æ™‚é–“å½“ãŸã‚Šã®æ©Ÿæ¢°æ›æ°—è¨­å‚™ã®æ¶ˆè²»é›»åŠ›é‡[kWh/h]

    """
    if V is None:
        return np.zeros(24 * 365)

    schedule = load_schedule()
    schedule_v = get_schedule_v(schedule)

    input = V['input']

    type = V['type']

    # ç†±äº¤æ›å‹æ›æ°—ã¸ã®é…æ…®
    if HEX is not None:
        type_he = type + 'ï¼ˆç†±äº¤æ›å‹æ›æ°—è¨­å‚™ï¼‰'
    else:
        type_he = type

    # æœ‰åŠ¹æ›æ°—é‡ç‡
    if type.endswith('ç¬¬ä¸€ç¨®æ›æ°—è¨­å‚™'):
        e = V.get('v_e') or 1.0
    else:
        e = 1.0

    if input == 'è©•ä¾¡ã—ãªã„':
        # SFPè¨ˆç®—
        if type.startswith("ãƒ€ã‚¯ãƒˆå¼"):
            f_SFP = table_a_1[type_he]
        elif type.startswith("å£ä»˜ã‘å¼"):
            f_SFP = table_a_3[type_he]
        else:
            raise ValueError(type)

    elif input == 'çœã‚¨ãƒãƒ«ã‚®ãƒ¼æ‰‹æ³•':
        # SFPè¨ˆç®—
        if type.startswith("ãƒ€ã‚¯ãƒˆå¼"):
            f_SFP = table_a_1[type_he] * table_a_2[type][V['duct']][V['current']]
        elif type.startswith("å£ä»˜ã‘å¼"):
            f_SFP = table_a_3[type_he]
        else:
            raise ValueError(type)

    elif input == 'æ¯”æ¶ˆè²»é›»åŠ›':
        f_SFP = V['f_SFP']
    else:
        raise ValueError(input)

    # æ—¥ä»˜dã®æ™‚åˆ»tã«ãŠã‘ã‚‹æ¯”æ¶ˆè²»é›»åŠ›f_SFP_d_tã¯ã€æ—¥ä»˜dã®æ™‚åˆ»tã«ä¾ã‚‰ãšåŒã˜å€¤f_SFPã«ç­‰ã—ã„
    f_SFP_d_t = np.repeat(f_SFP, 24 * 365)
    E_E_VG_d_t = calc_E_E_VG_d_t(f_SFP_d_t, A_A, V['N'], e)
    E_E_VL_d_t = calc_E_E_VL_d_t(n_p, schedule_v)

    return E_E_VG_d_t + E_E_VL_d_t  # (1)


# ============================================================================
# 6. å…¨èˆ¬æ›æ°—è¨­å‚™ã®æ¶ˆè²»é›»åŠ›é‡
# ============================================================================

def calc_E_E_VG_d_t(f_SFP_d_t, A_A, N, e):
    """1 æ™‚é–“å½“ãŸã‚Šã®å…¨èˆ¬æ›æ°—è¨­å‚™ã®æ¶ˆè²»é›»åŠ›é‡ï¼ˆkWh/hï¼‰

    Args:
      f_SFP_d_t(ndarray): æ—¥ä»˜dã®æ™‚åˆ»tã«ãŠã‘ã‚‹å…¨èˆ¬æ›æ°—è¨­å‚™ã®æ¯”æ¶ˆè²»é›»åŠ›[W/(m^3/h)]
      A_A(float): åºŠé¢ç©ã®åˆè¨ˆ[m^2]
      N(float): æ›æ°—å›æ•°[1/h]
      e(float): æœ‰åŠ¹æ›æ°—é‡ç‡

    Returns:
      ndarray: E_E_VG_d_t æ—¥ä»˜dã®æ™‚åˆ»tã«ãŠã‘ã‚‹1æ™‚é–“å½“ãŸã‚Šã®å…¨èˆ¬æ›æ°—è¨­å‚™ã®æ¶ˆè²»é›»åŠ›é‡[kWh/h]

    """
    V_R = calc_V_R(A_A, N, e)
    return f_SFP_d_t * V_R / 1000 # (2)


def calc_V_R(A_A, N, e):
    """å…¨èˆ¬æ›æ°—è¨­å‚™ã®å‚ç…§æ©Ÿæ¢°æ›æ°—é‡

    Args:
      A_A(float): åºŠé¢ç©ã®åˆè¨ˆ[m^2]
      N(float): æ›æ°—å›æ•°[1/h]
      e(float): æœ‰åŠ¹æ›æ°—é‡ç‡

    Returns:
      float: V_R å…¨èˆ¬æ›æ°—è¨­å‚™ã®å‚ç…§æ©Ÿæ¢°æ›æ°—é‡[m^3/h]

    """
    H_R = get_H_R()
    a = get_a()
    return A_A * H_R * N * a / e


# ============================================================================
# 6.1 å‚ç…§å¤©äº•é«˜ã•
# ============================================================================

def get_H_R():
    """å‚ç…§å¤©äº•é«˜ã•ã®å–å¾—

    Args:

    Returns:
      float: H_R å‚ç…§å¤©äº•é«˜ã•[m](=2.4[m])

    """
    return 2.4


# ============================================================================
# 6.2 æ›æ°—å›æ•°
# ============================================================================

# ============================================================================
# 6.3 å…¨èˆ¬æ›æ°—è¨­å‚™ã®æ›æ°—é‡ã®ä½™è£•ç‡
# ============================================================================

def get_a():
    """å…¨èˆ¬æ›æ°—è¨­å‚™ã®æ›æ°—é‡ã®ä½™è£•ç‡

    Args:

    Returns:
      float: a å…¨èˆ¬æ›æ°—è¨­å‚™ã®æ›æ°—é‡ã®ä½™è£•ç‡(=1.1)

    """
    return 1.1


# ============================================================================
# 6.4 æ¯”æ¶ˆè²»é›»åŠ›
# ============================================================================

def get_f_SFP(P, V_d):
    """æ¯”æ¶ˆè²»é›»åŠ›ã®å–å¾—

    Args:
      P(float): å…¨èˆ¬æ›æ°—è¨­å‚™ã®æ¶ˆè²»é›»åŠ›[W]
      V_d(float): å…¨èˆ¬æ›æ°—è¨­å‚™ã®è¨­è¨ˆé¢¨é‡[m^3/h]

    Returns:
      float: f_SEPã€€æ¯”æ¶ˆè²»é›»åŠ›[W/(m^3/h)]

    """
    f_SFP = P / V_d
    # 1/100 æœªæº€ã®ç«¯æ•°ã‚’åˆ‡ã‚Šä¸Šã’ãŸå°æ•°ç¬¬äºŒä½ã¾ã§ã®å€¤
    return ceil(f_SFP * 100) / 100


# ============================================================================
# 6.5 æœ‰åŠ¹æ›æ°—é‡ç‡
# ============================================================================

def get_e():
    """æœ‰åŠ¹æ›æ°—é‡ç‡ã®å–å¾—

    Args:

    Returns:
      float: eturns: eturn: e æœ‰åŠ¹æ›æ°—é‡ç‡

    """
    return 1.0


# ============================================================================
# 7. å±€æ‰€æ›æ°—è¨­å‚™ã®æ¶ˆè²»é›»åŠ›é‡
# ============================================================================

def calc_E_E_VL_d_t(n_p, schedule_v):
    """1 æ™‚é–“å½“ãŸã‚Šã®å±€æ‰€æ›æ°—è¨­å‚™ã®æ¶ˆè²»é›»åŠ›é‡

    Args:
      n_p(float): ä»®æƒ³å±…ä½äººæ•°
      schedule_v(ndarray): æ›æ°—ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

    Returns:
      ndarray: E_E_VL_d_t æ—¥ä»˜ğ‘‘ã®æ™‚åˆ»ğ‘¡ã«ãŠã‘ã‚‹ 1 æ™‚é–“å½“ãŸã‚Šã®å±€æ‰€æ›æ°—è¨­å‚™ã®æ¶ˆè²»é›»åŠ›é‡[kWh/h]

    """
    # (5)
    if 1 <= n_p and n_p <= 2:
        E_E_VL_1_d_t = get_E_E_VL_p_d_t(1, schedule_v)
        E_E_VL_2_d_t = get_E_E_VL_p_d_t(2, schedule_v)
        return E_E_VL_1_d_t * (2 - n_p) / (2 - 1) + E_E_VL_2_d_t * (n_p - 1) / (2 - 1)
    elif 2 <= n_p and n_p <= 3:
        E_E_VL_2_d_t = get_E_E_VL_p_d_t(2, schedule_v)
        E_E_VL_3_d_t = get_E_E_VL_p_d_t(3, schedule_v)
        return E_E_VL_2_d_t * (3 - n_p) / (3 - 2) + E_E_VL_3_d_t * (n_p - 2) / (3 - 2)
    elif 3 <= n_p and n_p <= 4:
        E_E_VL_3_d_t = get_E_E_VL_p_d_t(3, schedule_v)
        E_E_VL_4_d_t = get_E_E_VL_p_d_t(4, schedule_v)
        return E_E_VL_3_d_t * (4 - n_p) / (4 - 3) + E_E_VL_4_d_t * (n_p - 3) / (4 - 3)


def get_E_E_VL_p_d_t(p, schedule_v):
    """å±€æ‰€æ›æ°—è¨­å‚™ã® 1 æ™‚é–“å½“ãŸã‚Šã®æ¶ˆè²»é›»åŠ›é‡

    Args:
      p(float): å±…ä½äººæ•°
      schedule_v(ndarray): æ›æ°—ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

    Returns:
      ndarray: E_E_VL_p_d_t æ—¥ä»˜ğ‘‘ã®æ™‚åˆ»ğ‘¡ã«ãŠã‘ã‚‹1æ™‚é–“å½“ãŸã‚Šã®å±…ä½äººæ•°ãŒğ‘äººã«ãŠã‘ã‚‹å±€æ‰€æ›æ°—è¨­å‚™ã®æ¶ˆè²»é›»åŠ›é‡[kWh/h]

    """
    # å…¨æ—¥å¹³æ—¥ã¨ã¿ãªã—ãŸ24æ™‚é–“365æ—¥ã®æ¶ˆè²»é›»åŠ›é‡
    tmp_0 = np.tile([table_c_1[i][(p - 1) * 3] for i in range(24)], 365)

    # ä¼‘æ—¥å¤–å‡ºã¨ã¿ãªã—ãŸ24æ™‚é–“365æ—¥ã®æ¶ˆè²»é›»åŠ›é‡
    tmp_1 = np.tile([table_c_1[i][(p - 1) * 3 + 1] for i in range(24)], 365)

    # ä¼‘æ—¥åœ¨å®…ã¨ã¿ãªã—ãŸ24æ™‚é–“365æ—¥ã®æ¶ˆè²»é›»åŠ›é‡
    tmp_2 = np.tile([table_c_1[i][(p - 1) * 3 + 2] for i in range(24)], 365)

    # æ™‚é–“å˜ä½ã«å±•é–‹ã—ãŸç”Ÿæ´»ãƒ‘ã‚¿ãƒ¼ãƒ³
    schedule_extend = np.repeat(schedule_v, 24)

    tmp = (tmp_0 * (schedule_extend == 'å¹³æ—¥')
           + tmp_1 * (schedule_extend == 'ä¼‘æ—¥å¤–')
           + tmp_2 * (schedule_extend == 'ä¼‘æ—¥åœ¨'))

    return tmp / 1000


# ============================================================================
# ä»˜éŒ² A å…¨èˆ¬æ›æ°—è¨­å‚™ã®æ¯”æ¶ˆè²»é›»åŠ›
# ============================================================================

# ============================================================================
# A.1 ãƒ€ã‚¯ãƒˆå¼æ›æ°—è¨­å‚™
# ============================================================================

# è¡¨ A.1 åŸºæœ¬ã¨ãªã‚‹æ¯”æ¶ˆè²»é›»åŠ›
table_a_1 = {
    'ãƒ€ã‚¯ãƒˆå¼ç¬¬ä¸€ç¨®æ›æ°—è¨­å‚™ï¼ˆç†±äº¤æ›å‹æ›æ°—è¨­å‚™ï¼‰': 0.70,
    'ãƒ€ã‚¯ãƒˆå¼ç¬¬ä¸€ç¨®æ›æ°—è¨­å‚™': 0.50,
    'ãƒ€ã‚¯ãƒˆå¼ç¬¬äºŒç¨®æ›æ°—è¨­å‚™åˆã¯ãƒ€ã‚¯ãƒˆå¼ç¬¬ä¸‰ç¨®æ›æ°—è¨­å‚™': 0.40
}

# çœã‚¨ãƒãƒ«ã‚®ãƒ¼å¯¾ç­–ã®åŠ¹æœç‡
table_a_2 = {
    'ãƒ€ã‚¯ãƒˆå¼ç¬¬ä¸€ç¨®æ›æ°—è¨­å‚™': {
        'å†…å¾„ 75mm ä»¥ä¸Šã®ãƒ€ã‚¯ãƒˆã®ã¿ä½¿ç”¨': {
            'ç›´æµ': 0.455,
            'äº¤æµã€åˆã¯ç›´æµã¨äº¤æµã®ä½µç”¨': 0.700
        },
        'ä¸Šè¨˜ä»¥å¤–': {
            'ç›´æµã‚ã‚‹ã„ã¯äº¤æµ': 1.000
        }
    },
    'ãƒ€ã‚¯ãƒˆå¼ç¬¬äºŒç¨®æ›æ°—è¨­å‚™åˆã¯ãƒ€ã‚¯ãƒˆå¼ç¬¬ä¸‰ç¨®æ›æ°—è¨­å‚™': {
        'å†…å¾„ 75mm ä»¥ä¸Šã®ãƒ€ã‚¯ãƒˆã®ã¿ä½¿ç”¨': {
            'ç›´æµ': 0.360,
            'äº¤æµã€åˆã¯ç›´æµã¨äº¤æµã®ä½µç”¨': 0.600
        },
        'ä¸Šè¨˜ä»¥å¤–': {
            'ç›´æµã‚ã‚‹ã„ã¯äº¤æµ': 1.000
        }
    }
}

# ============================================================================
# A.2 å£ä»˜ã‘å¼æ›æ°—è¨­å‚™
# ============================================================================

# è¡¨ A.3 å£ä»˜ã‘å¼å…¨èˆ¬æ›æ°—è¨­å‚™ã®æ¯”æ¶ˆè²»é›»åŠ›
table_a_3 = {
    'å£ä»˜ã‘å¼ç¬¬ä¸€ç¨®æ›æ°—è¨­å‚™ï¼ˆç†±äº¤æ›å‹æ›æ°—è¨­å‚™ï¼‰': 0.70,
    'å£ä»˜ã‘å¼ç¬¬ä¸€ç¨®æ›æ°—è¨­å‚™': 0.40,
    'å£ä»˜ã‘å¼ç¬¬äºŒç¨®æ›æ°—è¨­å‚™åˆã¯å£ä»˜ã‘å¼ç¬¬ä¸‰ç¨®æ›æ°—è¨­å‚™': 0.30,
}

# ä»˜éŒ² C å±€æ‰€æ›æ°—è¨­å‚™ã® 1 æ™‚é–“å½“ãŸã‚Šã®æ¶ˆè²»é›»åŠ›é‡
table_c_1 = [
    (0.13, 0.13, 0.13, 0.25, 0.25, 0.25, 0.38, 0.38, 0.38, 0.5, 0.5, 0.5),
    (0.13, 0.13, 0.13, 0.25, 0.25, 0.25, 0.38, 0.38, 0.38, 0.5, 0.5, 0.5),
    (0.13, 0.13, 0.13, 0.25, 0.25, 0.25, 0.38, 0.38, 0.38, 0.5, 0.5, 0.5),
    (0.13, 0.13, 0.13, 0.25, 0.25, 0.25, 0.38, 0.38, 0.38, 0.5, 0.5, 0.5),
    (0.13, 0.13, 0.13, 0.25, 0.25, 0.25, 0.38, 0.38, 0.38, 0.5, 0.5, 0.5),
    (0.13, 0.13, 0.13, 0.25, 0.25, 0.25, 0.38, 0.38, 0.38, 0.5, 0.5, 0.5),
    (3.38, 0.33, 0.13, 6.75, 0.67, 0.25, 10.13, 1, 0.38, 13.51, 1.33, 0.5),
    (0.54, 0.33, 0.54, 1.08, 0.67, 1.08, 1.63, 1, 1.63, 2.17, 1.33, 2.17),
    (0.54, 7.05, 3.79, 1.08, 14.09, 7.59, 1.63, 21.14, 11.38, 2.17, 28.18, 15.18),
    (0.13, 0.13, 0.33, 0.25, 0.25, 0.67, 0.38, 0.38, 1, 0.5, 0.5, 1.33),
    (0.33, 0.13, 0.54, 0.67, 0.25, 1.08, 1, 0.38, 1.63, 1.33, 0.5, 2.17),
    (0.13, 0.13, 0.33, 0.25, 0.25, 0.67, 0.38, 0.38, 1, 0.5, 0.5, 1.33),
    (3.38, 0.13, 3.38, 6.75, 0.25, 6.75, 10.13, 0.38, 10.13, 13.51, 0.5, 13.51),
    (0.33, 0.13, 0.33, 0.67, 0.25, 0.67, 1, 0.38, 1, 1.33, 0.5, 1.33),
    (0.13, 0.13, 0.13, 0.25, 0.25, 0.25, 0.38, 0.38, 0.38, 0.5, 0.5, 0.5),
    (0.13, 0.13, 0.13, 0.25, 0.25, 0.25, 0.38, 0.38, 0.38, 0.5, 0.5, 0.5),
    (0.33, 0.13, 0.54, 0.67, 0.25, 1.08, 1, 0.38, 1.63, 1.33, 0.5, 2.17),
    (0.33, 0.13, 6.42, 0.67, 0.25, 12.84, 1, 0.38, 19.26, 1.33, 0.5, 25.68),
    (6.42, 0.13, 6.42, 12.84, 0.25, 12.84, 19.26, 0.38, 19.26, 25.68, 0.5, 25.68),
    (6.42, 0.13, 0.13, 12.84, 0.25, 0.25, 19.26, 0.38, 0.38, 25.68, 0.5, 0.5),
    (0.33, 0.54, 0.33, 0.67, 1.08, 0.67, 1, 1.63, 1, 1.33, 2.17, 1.33),
    (0.33, 0.33, 6.28, 0.67, 0.67, 12.56, 1, 1, 18.84, 1.33, 1.33, 25.12),
    (6.28, 3.52, 6.49, 12.56, 7.03, 12.98, 18.84, 10.55, 19.47, 25.12, 14.06, 25.95),
    (6.7, 6.28, 3.31, 13.39, 12.56, 6.61, 20.09, 18.84, 9.92, 26.79, 25.12, 13.23)
]
